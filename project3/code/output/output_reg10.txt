#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Configureation file for the regression CNN
"""
import os
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
import tensorflow.python.util.deprecation as deprecation
deprecation._PRINT_DEPRECATION_WARNINGS = False
import tensorflow as tf
from generate import load_data
from tools import preprocess, r2_score, multiply_data


###############################################################################
# Set up the data
###############################################################################

type = "regression"

path = "../data/"
filename = "maps_(100, 28, 28, 20)_0.008_0.0_0.0_10.0_1.0e+00_False_.npy"
data_file = path+filename
slice = None

#maps, labels, stats = load_data(file=data_file, slice=slice)

from generate import multiple_load_data
maps, labels, stats = multiple_load_data(data_file, slice, 100)


(X_train, y_train), (X_test, y_test) = preprocess(maps, labels,
                                                train_size = 0.8,
                                                regress=True,
                                                scale=True,
                                                seed=42,
                                                shuffle=True)


###############################################################################
# for create_model()
###############################################################################

input_shape = (28, 28, 20)     # Shape of the images, holds the raw pixel values

n_filters = 16                  # For the first Conv2D layer
kernel_size = (5,5)
layer_config = [32, 64]         # (layer1, layer2, layer3, ....)

connected_neurons = 128         # For the first Dense layer
n_categories = 1                # For the last Dense layer

input_activation  = "relu"
hidden_activation = "relu"
output_activation = "sigmoid"

reg = None  #tf.keras.regularizers.l2(l=0.1)

###############################################################################
# for train_model()
###############################################################################

model_dir = "tmp/"           # Where to save the model

epochs = 100
batch_size = 10

opt = tf.keras.optimizers.Adam(learning_rate=1e-4)

early_stop = tf.keras.callbacks.EarlyStopping(monitor='val_loss', patience=30)

loss = "mean_squared_error"
metrics = [r2_score]





(ML) alida ~/Documents/uio/Master/FYS-STK4155/project3/code master(*?) $ python CNN.py -rn reg10
________________________________________________________________

Analysis: regression
Save as:  reg10
________________________________________________________________

Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
conv2d (Conv2D)              (None, 28, 28, 16)        8016
_________________________________________________________________
max_pooling2d (MaxPooling2D) (None, 14, 14, 16)        0
_________________________________________________________________
conv2d_1 (Conv2D)            (None, 14, 14, 32)        12832
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 7, 7, 32)          0
_________________________________________________________________
conv2d_2 (Conv2D)            (None, 7, 7, 64)          51264
_________________________________________________________________
max_pooling2d_2 (MaxPooling2 (None, 3, 3, 64)          0
_________________________________________________________________
flatten (Flatten)            (None, 576)               0
_________________________________________________________________
dense (Dense)                (None, 128)               73856
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 129
=================================================================
Total params: 146,097
Trainable params: 146,097
Non-trainable params: 0
_________________________________________________________________

training: 6400 - validation: 1600 - Untrained, r2_score: -3.70%
_________________________________________________________________

Epoch 1/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0823 - r2_score: -0.1576 - val_loss: 0.0799 - val_r2_score: -0.1180
Epoch 2/100
512/512 [==============================] - 33s 64ms/step - loss: 0.0822 - r2_score: -0.1585 - val_loss: 0.0798 - val_r2_score: -0.1179
Epoch 3/100
512/512 [==============================] - 39s 76ms/step - loss: 0.0821 - r2_score: -0.1327 - val_loss: 0.0797 - val_r2_score: -0.1158
Epoch 4/100
512/512 [==============================] - 36s 71ms/step - loss: 0.0818 - r2_score: -0.1368 - val_loss: 0.0794 - val_r2_score: -0.1109
Epoch 5/100
512/512 [==============================] - 36s 70ms/step - loss: 0.0812 - r2_score: -0.1460 - val_loss: 0.0778 - val_r2_score: -0.0896
Epoch 6/100
512/512 [==============================] - 37s 73ms/step - loss: 0.0768 - r2_score: -0.0895 - val_loss: 0.0700 - val_r2_score: 0.0043
Epoch 7/100
512/512 [==============================] - 35s 69ms/step - loss: 0.0410 - r2_score: 0.4103 - val_loss: 0.0187 - val_r2_score: 0.7261
Epoch 8/100
512/512 [==============================] - 34s 67ms/step - loss: 0.0165 - r2_score: 0.7477 - val_loss: 0.0151 - val_r2_score: 0.7724
Epoch 9/100
512/512 [==============================] - 37s 73ms/step - loss: 0.0145 - r2_score: 0.7752 - val_loss: 0.0119 - val_r2_score: 0.8189
Epoch 10/100
512/512 [==============================] - 38s 75ms/step - loss: 0.0136 - r2_score: 0.7875 - val_loss: 0.0121 - val_r2_score: 0.8154
Epoch 11/100
512/512 [==============================] - 42s 83ms/step - loss: 0.0128 - r2_score: 0.7977 - val_loss: 0.0104 - val_r2_score: 0.8399
Epoch 12/100
512/512 [==============================] - 33s 65ms/step - loss: 0.0120 - r2_score: 0.8110 - val_loss: 0.0097 - val_r2_score: 0.8503
Epoch 13/100
512/512 [==============================] - 32s 63ms/step - loss: 0.0118 - r2_score: 0.8153 - val_loss: 0.0106 - val_r2_score: 0.8361
Epoch 14/100
512/512 [==============================] - 37s 72ms/step - loss: 0.0115 - r2_score: 0.8192 - val_loss: 0.0097 - val_r2_score: 0.8489
Epoch 15/100
512/512 [==============================] - 30s 58ms/step - loss: 0.0120 - r2_score: 0.8126 - val_loss: 0.0147 - val_r2_score: 0.7713
Epoch 16/100
512/512 [==============================] - 32s 62ms/step - loss: 0.0115 - r2_score: 0.8206 - val_loss: 0.0091 - val_r2_score: 0.8590
Epoch 17/100
512/512 [==============================] - 38s 74ms/step - loss: 0.0115 - r2_score: 0.8195 - val_loss: 0.0098 - val_r2_score: 0.8483
Epoch 18/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0113 - r2_score: 0.8240 - val_loss: 0.0120 - val_r2_score: 0.8137
Epoch 19/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0113 - r2_score: 0.8254 - val_loss: 0.0084 - val_r2_score: 0.8698
Epoch 20/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0102 - r2_score: 0.8388 - val_loss: 0.0126 - val_r2_score: 0.7998
Epoch 21/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0104 - r2_score: 0.8358 - val_loss: 0.0087 - val_r2_score: 0.8641
Epoch 22/100
512/512 [==============================] - 30s 58ms/step - loss: 0.0118 - r2_score: 0.8120 - val_loss: 0.0089 - val_r2_score: 0.8599
Epoch 23/100
512/512 [==============================] - 34s 67ms/step - loss: 0.0117 - r2_score: 0.8148 - val_loss: 0.0147 - val_r2_score: 0.7699
Epoch 24/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0113 - r2_score: 0.8178 - val_loss: 0.0095 - val_r2_score: 0.8511
Epoch 25/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0113 - r2_score: 0.8183 - val_loss: 0.0082 - val_r2_score: 0.8711
Epoch 26/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0095 - r2_score: 0.8508 - val_loss: 0.0080 - val_r2_score: 0.8744
Epoch 27/100
512/512 [==============================] - 29s 56ms/step - loss: 0.0103 - r2_score: 0.8351 - val_loss: 0.0171 - val_r2_score: 0.7249
Epoch 28/100
512/512 [==============================] - 29s 56ms/step - loss: 0.0107 - r2_score: 0.8312 - val_loss: 0.0102 - val_r2_score: 0.8379
Epoch 29/100
512/512 [==============================] - 30s 59ms/step - loss: 0.0099 - r2_score: 0.8444 - val_loss: 0.0082 - val_r2_score: 0.8695
Epoch 30/100
512/512 [==============================] - 35s 68ms/step - loss: 0.0098 - r2_score: 0.8475 - val_loss: 0.0085 - val_r2_score: 0.8670
Epoch 31/100
512/512 [==============================] - 35s 68ms/step - loss: 0.0111 - r2_score: 0.8244 - val_loss: 0.0081 - val_r2_score: 0.8734
Epoch 32/100
512/512 [==============================] - 31s 61ms/step - loss: 0.0106 - r2_score: 0.8306 - val_loss: 0.0076 - val_r2_score: 0.8811
Epoch 33/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0121 - r2_score: 0.8104 - val_loss: 0.0226 - val_r2_score: 0.6379
Epoch 34/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0107 - r2_score: 0.8249 - val_loss: 0.0075 - val_r2_score: 0.8834
Epoch 35/100
512/512 [==============================] - 31s 60ms/step - loss: 0.0100 - r2_score: 0.8476 - val_loss: 0.0073 - val_r2_score: 0.8865
Epoch 36/100
512/512 [==============================] - 33s 65ms/step - loss: 0.0096 - r2_score: 0.8470 - val_loss: 0.0078 - val_r2_score: 0.8789
Epoch 37/100
512/512 [==============================] - 34s 66ms/step - loss: 0.0096 - r2_score: 0.8491 - val_loss: 0.0105 - val_r2_score: 0.8334
Epoch 38/100
512/512 [==============================] - 41s 79ms/step - loss: 0.0121 - r2_score: 0.8073 - val_loss: 0.0089 - val_r2_score: 0.8615
Epoch 39/100
512/512 [==============================] - 38s 73ms/step - loss: 0.0101 - r2_score: 0.8423 - val_loss: 0.0072 - val_r2_score: 0.8890
Epoch 40/100
512/512 [==============================] - 37s 72ms/step - loss: 0.0097 - r2_score: 0.8460 - val_loss: 0.0083 - val_r2_score: 0.8702
Epoch 41/100
512/512 [==============================] - 35s 69ms/step - loss: 0.0091 - r2_score: 0.8575 - val_loss: 0.0071 - val_r2_score: 0.8883
Epoch 42/100
512/512 [==============================] - 39s 76ms/step - loss: 0.0099 - r2_score: 0.8443 - val_loss: 0.0182 - val_r2_score: 0.7099
Epoch 43/100
512/512 [==============================] - 37s 73ms/step - loss: 0.0100 - r2_score: 0.8363 - val_loss: 0.0087 - val_r2_score: 0.8645
Epoch 44/100
512/512 [==============================] - 38s 74ms/step - loss: 0.0102 - r2_score: 0.8377 - val_loss: 0.0085 - val_r2_score: 0.8653
Epoch 45/100
512/512 [==============================] - 33s 64ms/step - loss: 0.0102 - r2_score: 0.8391 - val_loss: 0.0074 - val_r2_score: 0.8844
Epoch 46/100
512/512 [==============================] - 30s 59ms/step - loss: 0.0103 - r2_score: 0.8359 - val_loss: 0.0074 - val_r2_score: 0.8835
Epoch 47/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0102 - r2_score: 0.8433 - val_loss: 0.0134 - val_r2_score: 0.7839
Epoch 48/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0100 - r2_score: 0.8438 - val_loss: 0.0073 - val_r2_score: 0.8842
Epoch 49/100
512/512 [==============================] - 27s 53ms/step - loss: 0.0103 - r2_score: 0.8414 - val_loss: 0.0072 - val_r2_score: 0.8863
Epoch 50/100
512/512 [==============================] - 32s 63ms/step - loss: 0.0104 - r2_score: 0.8352 - val_loss: 0.0170 - val_r2_score: 0.7283
Epoch 51/100
512/512 [==============================] - 38s 74ms/step - loss: 0.0119 - r2_score: 0.8101 - val_loss: 0.0073 - val_r2_score: 0.8858
Epoch 52/100
512/512 [==============================] - 36s 71ms/step - loss: 0.0102 - r2_score: 0.8442 - val_loss: 0.0082 - val_r2_score: 0.8715
Epoch 53/100
512/512 [==============================] - 36s 71ms/step - loss: 0.0089 - r2_score: 0.8633 - val_loss: 0.0094 - val_r2_score: 0.8517
Epoch 54/100
512/512 [==============================] - 37s 72ms/step - loss: 0.0104 - r2_score: 0.8337 - val_loss: 0.0110 - val_r2_score: 0.8249
Epoch 55/100
512/512 [==============================] - 33s 65ms/step - loss: 0.0090 - r2_score: 0.8590 - val_loss: 0.0075 - val_r2_score: 0.8818
Epoch 56/100
512/512 [==============================] - 32s 63ms/step - loss: 0.0096 - r2_score: 0.8507 - val_loss: 0.0067 - val_r2_score: 0.8943
Epoch 57/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0090 - r2_score: 0.8549 - val_loss: 0.0081 - val_r2_score: 0.8709
Epoch 58/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0084 - r2_score: 0.8687 - val_loss: 0.0088 - val_r2_score: 0.8595
Epoch 59/100
512/512 [==============================] - 27s 53ms/step - loss: 0.0088 - r2_score: 0.8639 - val_loss: 0.0104 - val_r2_score: 0.8343
Epoch 60/100
512/512 [==============================] - 29s 56ms/step - loss: 0.0086 - r2_score: 0.8628 - val_loss: 0.0060 - val_r2_score: 0.9051
Epoch 61/100
512/512 [==============================] - 38s 74ms/step - loss: 0.0080 - r2_score: 0.8728 - val_loss: 0.0058 - val_r2_score: 0.9092
Epoch 62/100
512/512 [==============================] - 32s 63ms/step - loss: 0.0079 - r2_score: 0.8737 - val_loss: 0.0060 - val_r2_score: 0.9053
Epoch 63/100
512/512 [==============================] - 27s 53ms/step - loss: 0.0074 - r2_score: 0.8833 - val_loss: 0.0055 - val_r2_score: 0.9142
Epoch 64/100
512/512 [==============================] - 27s 53ms/step - loss: 0.0079 - r2_score: 0.8772 - val_loss: 0.0052 - val_r2_score: 0.9174
Epoch 65/100
512/512 [==============================] - 29s 56ms/step - loss: 0.0079 - r2_score: 0.8753 - val_loss: 0.0048 - val_r2_score: 0.9234
Epoch 66/100
512/512 [==============================] - 27s 52ms/step - loss: 0.0069 - r2_score: 0.8926 - val_loss: 0.0123 - val_r2_score: 0.8024
Epoch 67/100
512/512 [==============================] - 29s 56ms/step - loss: 0.0064 - r2_score: 0.8992 - val_loss: 0.0065 - val_r2_score: 0.8952
Epoch 68/100
512/512 [==============================] - 28s 56ms/step - loss: 0.0072 - r2_score: 0.8846 - val_loss: 0.0063 - val_r2_score: 0.8997
Epoch 69/100
512/512 [==============================] - 29s 57ms/step - loss: 0.0078 - r2_score: 0.8715 - val_loss: 0.0045 - val_r2_score: 0.9286
Epoch 70/100
512/512 [==============================] - 28s 55ms/step - loss: 0.0067 - r2_score: 0.8900 - val_loss: 0.0099 - val_r2_score: 0.8419
Epoch 71/100
512/512 [==============================] - 29s 56ms/step - loss: 0.0053 - r2_score: 0.9160 - val_loss: 0.0043 - val_r2_score: 0.9314
Epoch 72/100
512/512 [==============================] - 30s 58ms/step - loss: 0.0071 - r2_score: 0.8905 - val_loss: 0.0052 - val_r2_score: 0.9160
Epoch 73/100
512/512 [==============================] - 29s 56ms/step - loss: 0.0071 - r2_score: 0.8842 - val_loss: 0.0093 - val_r2_score: 0.8472
Epoch 74/100
512/512 [==============================] - 34s 66ms/step - loss: 0.0076 - r2_score: 0.8832 - val_loss: 0.0063 - val_r2_score: 0.8991
Epoch 75/100
512/512 [==============================] - 36s 71ms/step - loss: 0.0069 - r2_score: 0.8902 - val_loss: 0.0045 - val_r2_score: 0.9309
Epoch 76/100
512/512 [==============================] - 32s 63ms/step - loss: 0.0063 - r2_score: 0.9019 - val_loss: 0.0104 - val_r2_score: 0.8326
Epoch 77/100
512/512 [==============================] - 37s 72ms/step - loss: 0.0079 - r2_score: 0.8710 - val_loss: 0.0055 - val_r2_score: 0.9140
Epoch 78/100
512/512 [==============================] - 35s 69ms/step - loss: 0.0072 - r2_score: 0.8875 - val_loss: 0.0086 - val_r2_score: 0.8617
Epoch 79/100
512/512 [==============================] - 35s 68ms/step - loss: 0.0068 - r2_score: 0.8909 - val_loss: 0.0044 - val_r2_score: 0.9327
Epoch 80/100
512/512 [==============================] - 43s 84ms/step - loss: 0.0073 - r2_score: 0.8763 - val_loss: 0.0062 - val_r2_score: 0.9017
Epoch 81/100
512/512 [==============================] - 39s 76ms/step - loss: 0.0070 - r2_score: 0.8875 - val_loss: 0.0049 - val_r2_score: 0.9247
Epoch 82/100
512/512 [==============================] - 40s 78ms/step - loss: 0.0066 - r2_score: 0.8964 - val_loss: 0.0163 - val_r2_score: 0.7355
Epoch 83/100
512/512 [==============================] - 33s 64ms/step - loss: 0.0080 - r2_score: 0.8691 - val_loss: 0.0069 - val_r2_score: 0.8901
Epoch 84/100
512/512 [==============================] - 35s 68ms/step - loss: 0.0080 - r2_score: 0.8716 - val_loss: 0.0060 - val_r2_score: 0.9049
Epoch 85/100
512/512 [==============================] - 34s 67ms/step - loss: 0.0066 - r2_score: 0.8953 - val_loss: 0.0097 - val_r2_score: 0.8436
Epoch 86/100
512/512 [==============================] - 36s 69ms/step - loss: 0.0090 - r2_score: 0.8540 - val_loss: 0.0061 - val_r2_score: 0.9045
Epoch 87/100
512/512 [==============================] - 39s 77ms/step - loss: 0.0070 - r2_score: 0.8908 - val_loss: 0.0062 - val_r2_score: 0.9011
Epoch 88/100
512/512 [==============================] - 30s 59ms/step - loss: 0.0075 - r2_score: 0.8784 - val_loss: 0.0155 - val_r2_score: 0.7497
Epoch 89/100
512/512 [==============================] - 40s 78ms/step - loss: 0.0074 - r2_score: 0.8817 - val_loss: 0.0043 - val_r2_score: 0.9333
Epoch 90/100
512/512 [==============================] - 35s 68ms/step - loss: 0.0090 - r2_score: 0.8595 - val_loss: 0.0054 - val_r2_score: 0.9159
Epoch 91/100
512/512 [==============================] - 32s 63ms/step - loss: 0.0067 - r2_score: 0.8900 - val_loss: 0.0052 - val_r2_score: 0.9192
Epoch 92/100
512/512 [==============================] - 31s 61ms/step - loss: 0.0085 - r2_score: 0.8607 - val_loss: 0.0054 - val_r2_score: 0.9158
Epoch 93/100
512/512 [==============================] - 33s 65ms/step - loss: 0.0073 - r2_score: 0.8808 - val_loss: 0.0041 - val_r2_score: 0.9362
Epoch 94/100
512/512 [==============================] - 34s 67ms/step - loss: 0.0060 - r2_score: 0.9074 - val_loss: 0.0039 - val_r2_score: 0.9405
Epoch 95/100
512/512 [==============================] - 34s 66ms/step - loss: 0.0075 - r2_score: 0.8788 - val_loss: 0.0192 - val_r2_score: 0.6875
Epoch 96/100
512/512 [==============================] - 33s 65ms/step - loss: 0.0058 - r2_score: 0.9084 - val_loss: 0.0059 - val_r2_score: 0.9084
Epoch 97/100
512/512 [==============================] - 31s 62ms/step - loss: 0.0065 - r2_score: 0.9007 - val_loss: 0.0048 - val_r2_score: 0.9252
Epoch 98/100
512/512 [==============================] - 34s 67ms/step - loss: 0.0064 - r2_score: 0.8984 - val_loss: 0.0047 - val_r2_score: 0.9285
Epoch 99/100
512/512 [==============================] - 33s 64ms/step - loss: 0.0060 - r2_score: 0.8993 - val_loss: 0.0032 - val_r2_score: 0.9512
Epoch 100/100
512/512 [==============================] - 33s 64ms/step - loss: 0.0060 - r2_score: 0.9034 - val_loss: 0.0032 - val_r2_score: 0.9507
_________________________________________________________________

r2_score: 95.78%
_________________________________________________________________
